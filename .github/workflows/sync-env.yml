name: Sync Environment Variables

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'env.example'
      - '.github/workflows/sync-env.yml'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Validate Required Secrets
        run: |
          echo "ðŸ” Validating required GitHub secrets..."
          echo ""
          
          MISSING_SECRETS=()
          
          # Check SSH_PRIVATE_KEY (required)
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("SSH_PRIVATE_KEY")
            echo "âŒ SSH_PRIVATE_KEY is missing"
          else
            echo "âœ… SSH_PRIVATE_KEY is set"
          fi
          
          # Check SERVER_IP (required)
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            MISSING_SECRETS+=("SERVER_IP")
            echo "âŒ SERVER_IP is missing"
          else
            echo "âœ… SERVER_IP is set: ${{ secrets.SERVER_IP }}"
          fi
          
          echo ""
          
          # If any secrets are missing, fail with clear instructions
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ ERROR: Missing required GitHub secrets!"
            echo ""
            echo "Please add the following secrets in GitHub:"
            echo "  1. Go to: https://github.com/Baileysgin/Smokava/settings/secrets/actions"
            echo "  2. Click 'New repository secret'"
            echo "  3. Add each missing secret:"
            echo ""
            for secret in "${MISSING_SECRETS[@]}"; do
              case "$secret" in
                SSH_PRIVATE_KEY)
                  echo "     - Name: SSH_PRIVATE_KEY"
                  echo "       Value: Your SSH private key (full key including -----BEGIN and -----END lines)"
                  ;;
                SERVER_IP)
                  echo "     - Name: SERVER_IP"
                  echo "       Value: 91.107.241.245"
                  ;;
              esac
            done
            echo ""
            echo "After adding secrets, re-run this workflow."
            exit 1
          fi
          
          echo "âœ… All required secrets are present!"
          echo ""

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Sync environment files
        run: |
          SSH_USER="${{ secrets.SSH_USER || 'root' }}"
          SSH_PORT="${{ secrets.SSH_PORT || '22' }}"
          SSH_TARGET="${SSH_USER}@${{ secrets.SERVER_IP }}"
          
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=60 \
              -o ServerAliveInterval=20 \
              -o ServerAliveCountMax=10 \
              -o TCPKeepAlive=yes \
              -o BatchMode=yes \
              -p ${SSH_PORT} \
              ${SSH_TARGET} \
              "bash -c '
          script: |
            cd /opt/smokava

            # Pull latest env.example
            git pull origin main

            # Update backend .env if needed (only add missing variables, don't overwrite existing)
            if [ -f backend/.env ]; then
              echo "âœ… Backend .env exists, preserving existing values"
            else
              echo "âš ï¸  Creating backend/.env from example"
              cp env.example backend/.env
              echo "âš ï¸  Please update backend/.env with your actual values!"
            fi

            # Update frontend .env.production if needed
            if [ -f frontend/.env.production ]; then
              echo "âœ… Frontend .env.production exists, preserving existing values"
            else
              echo "âš ï¸  Creating frontend/.env.production from example"
              cat > frontend/.env.production << EOF
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_MAPBOX_TOKEN=${{ secrets.NEXT_PUBLIC_MAPBOX_TOKEN }}
            EOF
            fi

            # Update admin-panel .env.production if needed
            if [ -f admin-panel/.env.production ]; then
              echo "âœ… Admin panel .env.production exists, preserving existing values"
            else
              echo "âš ï¸  Creating admin-panel/.env.production from example"
              cat > admin-panel/.env.production << EOF
            VITE_API_URL=${{ secrets.VITE_API_URL }}
            EOF
            fi

            echo \"âœ… Environment files synced!\"
              '"



