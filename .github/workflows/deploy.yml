name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create backup before deploy
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_HOST }} "cd /opt/smokava && bash scripts/db-backup.sh" || echo "âš ï¸ Backup failed, continuing with deployment..."

      - name: Pull latest code and deploy
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_HOST }} "cd /opt/smokava && \
            git fetch origin && \
            git reset --hard origin/main && \
            bash scripts/deploy.sh"

      - name: Wait for services to start
        run: |
          echo "â³ Waiting for services to start..."
          sleep 15

      - name: Health check
        run: |
          echo "ðŸ¥ Running health check..."
          API_URL="${{ secrets.API_URL }}"
          if [ -z "$API_URL" ]; then
            echo "âš ï¸ API_URL secret not set, skipping health check"
            exit 0
          fi
          
          # Ensure API_URL ends with /api
          if [[ ! "$API_URL" == */api ]]; then
            API_URL="${API_URL%/}/api"
          fi
          
          HEALTH_URL="${API_URL}/health"
          echo "Checking: ${HEALTH_URL}"
          
          for i in {1..5}; do
            if curl -f -s "${HEALTH_URL}" > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "â³ Attempt $i/5 failed, retrying in 5 seconds..."
            sleep 5
          done
          
          echo "âš ï¸ Health check failed after 5 attempts, but deployment may still be successful"
          exit 0

      - name: Verify services are running
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_HOST }} "cd /opt/smokava && \
            docker-compose ps && \
            echo '' && \
            echo 'âœ… Deployment verification complete'"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Code pulled from GitHub" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Services deployed using safe deployment script" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Health checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "- Verify services are running" >> $GITHUB_STEP_SUMMARY
          echo "- Check application logs if needed" >> $GITHUB_STEP_SUMMARY
