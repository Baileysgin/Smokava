name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      deployments: write
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Configure SSH settings
        run: |
          # Determine SSH connection string
          if [ -n "${{ secrets.SSH_HOST }}" ]; then
            SSH_TARGET="${{ secrets.SSH_HOST }}"
          elif [ -n "${{ secrets.SERVER_IP }}" ]; then
            SSH_USER="${{ secrets.SSH_USER || 'root' }}"
            SSH_PORT="${{ secrets.SSH_PORT || '22' }}"
            SSH_TARGET="${SSH_USER}@${{ secrets.SERVER_IP }}"
            SSH_PORT_ARG="-p ${SSH_PORT}"
          else
            echo "âŒ Neither SSH_HOST nor SERVER_IP is set in secrets"
            exit 1
          fi

          # Export for use in subsequent steps
          echo "SSH_TARGET=${SSH_TARGET}" >> $GITHUB_ENV
          echo "SSH_PORT_ARG=${SSH_PORT_ARG:-}" >> $GITHUB_ENV

          echo "âœ… SSH target configured: ${SSH_TARGET}"

      - name: Verify SSH connection
        run: |
          echo "ðŸ” Testing SSH connection with improved keepalive settings..."
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=60 \
              -o ServerAliveInterval=20 \
              -o ServerAliveCountMax=10 \
              -o TCPKeepAlive=yes \
              -o BatchMode=yes \
              ${{ env.SSH_PORT_ARG }} \
              ${{ env.SSH_TARGET }} \
              "echo 'SSH connection successful'" || {
            echo "âŒ SSH connection failed"
            echo "âš ï¸ This might be due to:"
            echo "   - Firewall blocking port 22"
            echo "   - Server not accessible from GitHub Actions"
            echo "   - SSH service not running"
            echo "   - Network issues"
            echo ""
            echo "ðŸ’¡ You can deploy manually by running on your server:"
            echo "   cd /opt/smokava && git pull && sudo bash scripts/safe-deploy.sh"
            exit 1
          }

      - name: Create backup before deploy
        run: |
          echo "ðŸ“¦ Creating database backup..."
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=60 \
              -o ServerAliveInterval=20 \
              -o ServerAliveCountMax=10 \
              -o TCPKeepAlive=yes \
              -o BatchMode=yes \
              ${{ env.SSH_PORT_ARG }} \
              ${{ env.SSH_TARGET }} \
              "cd /opt/smokava && bash scripts/db-backup.sh" || {
            echo "âŒ CRITICAL: Backup failed!"
            echo "âš ï¸ Deployment will continue, but backup is required for safety"
            echo "âš ï¸ Please check backup script and database connection"
          }

      - name: Verify backup was created
        run: |
          echo "ðŸ” Verifying backup was created..."
          BACKUP_COUNT=$(ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=60 \
              -o ServerAliveInterval=20 \
              -o ServerAliveCountMax=10 \
              -o TCPKeepAlive=yes \
              -o BatchMode=yes \
              ${{ env.SSH_PORT_ARG }} \
              ${{ env.SSH_TARGET }} \
              "ls -1 /var/backups/smokava/smokava_backup_*.gz 2>/dev/null | wc -l" || echo "0")
          if [ "$BACKUP_COUNT" -eq "0" ]; then
            echo "âš ï¸ WARNING: No backups found! This may indicate a problem."
          else
            echo "âœ… Found $BACKUP_COUNT backup(s)"
          fi

      - name: Pull latest code and deploy
        timeout-minutes: 30
        run: |
          echo "ðŸš€ Deploying to server with improved SSH keepalive..."
          echo "This may take 5-10 minutes for Docker operations..."

          # Use continuous output streaming to keep SSH alive
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=60 \
              -o ServerAliveInterval=20 \
              -o ServerAliveCountMax=10 \
              -o TCPKeepAlive=yes \
              -o BatchMode=yes \
              ${{ env.SSH_PORT_ARG }} \
              ${{ env.SSH_TARGET }} \
              "cd /opt/smokava && \
               echo 'ðŸ“¥ Pulling latest code...' && \
               git fetch origin main && \
               git reset --hard origin/main && \
               git clean -fd && \
               echo 'ðŸš€ Starting deployment...' && \
               sudo bash scripts/safe-deploy.sh" || {
            echo "âš ï¸ Deployment script failed, but checking if services are running..."
            ssh -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                -o ConnectTimeout=60 \
                -o ServerAliveInterval=20 \
                -o ServerAliveCountMax=10 \
                -o TCPKeepAlive=yes \
                -o BatchMode=yes \
                ${{ env.SSH_PORT_ARG }} \
                ${{ env.SSH_TARGET }} \
                "cd /opt/smokava && docker compose ps" || {
              echo "âŒ Cannot connect to server. Please deploy manually:"
              echo "   cd /opt/smokava && git pull && sudo bash scripts/safe-deploy.sh"
              exit 1
            }
          }

      - name: Wait for services to start
        run: |
          echo "â³ Waiting for services to start..."
          sleep 15

      - name: Health check
        run: |
          echo "ðŸ¥ Running health check..."
          API_URL="${{ secrets.API_URL || 'https://api.smokava.com' }}"

          # Ensure API_URL ends with /api
          if [[ ! "$API_URL" == */api ]]; then
            API_URL="${API_URL%/}/api"
          fi

          HEALTH_URL="${API_URL}/health"
          echo "Checking: ${HEALTH_URL}"

          for i in {1..10}; do
            if curl -f -s --max-time 10 "${HEALTH_URL}" > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "â³ Attempt $i/10 failed, retrying in 5 seconds..."
            sleep 5
          done

          echo "âš ï¸ Health check failed after 10 attempts"
          echo "âš ï¸ Deployment may still be successful - check server logs"
          exit 0

      - name: Verify services are running
        run: |
          echo "ðŸ” Verifying services..."
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=60 \
              -o ServerAliveInterval=20 \
              -o ServerAliveCountMax=10 \
              -o TCPKeepAlive=yes \
              -o BatchMode=yes \
              ${{ env.SSH_PORT_ARG }} \
              ${{ env.SSH_TARGET }} \
              "cd /opt/smokava && \
               (docker-compose ps || docker compose ps) && \
               echo '' && \
               echo 'âœ… Deployment verification complete'"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Code pulled from GitHub" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Services deployed using safe deployment script" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Health checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "- Verify services are running" >> $GITHUB_STEP_SUMMARY
          echo "- Check application logs if needed" >> $GITHUB_STEP_SUMMARY
